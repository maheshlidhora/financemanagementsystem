<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Liabilities Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            min-height: 350px;
        }

        .chart-card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chart-card .card-body {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        .chart-card canvas {
            max-width: 100%;
            max-height: 280px;
            width: 100% !important;
            height: auto !important;
        }

        .equal-height-row {
            display: flex;
            flex-wrap: wrap;
        }

        .equal-height-row .col-md-6 {
            display: flex;
            flex-direction: column;
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 0.35em 0.65em;
        }

        .bg-outstanding {
            background-color: #ffc107 !important;
        }

        .bg-partial {
            background-color: #17a2b8 !important;
        }

        .bg-paid {
            background-color: #28a745 !important;
        }

        .bg-overdue {
            background-color: #dc3545 !important;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3">
        <a class="navbar-brand" href="#">Finance Manager</a>
        <div class="ms-auto">
            <a th:href="@{/dashboard}" class="btn btn-outline-light btn-sm me-2">Dashboard</a>
            <a th:href="@{/accounts}" class="btn btn-outline-light btn-sm me-2">Accounts</a>
            <a th:href="@{/liabilities}" class="btn btn-outline-light btn-sm me-2">All Liabilities</a>
            <a th:href="@{/logout}" class="btn btn-outline-light btn-sm">Logout</a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-file-bar-graph"></i> Liabilities Report</h2>
            <a th:href="@{/liabilities}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Liabilities
            </a>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h5>Total Liabilities</h5>
                        <h3 th:text="${totalLiabilities}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h5>Outstanding</h5>
                        <h3 th:text="${outstandingLiabilities}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h5>Partial</h5>
                        <h3 th:text="${partialLiabilities}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h5>Paid</h5>
                        <h3 th:text="${paidLiabilities}">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overdue Cards -->
        <div class="row mb-4">
            <div class="col-md-4 offset-md-2">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h5>Overdue (Status)</h5>
                        <h3 th:text="${overdueLiabilities}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-dark text-white">
                    <div class="card-body text-center">
                        <h5>Functionally Overdue</h5>
                        <h3 th:text="${functionallyOverdue}">0</h3><small>Due date passed but not paid</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Outstanding Amount -->
        <div class="card bg-light mb-4">
            <div class="card-body text-center">
                <h5>Total Outstanding Amount</h5>
                <h2 class="text-danger" th:text="'$' + ${#numbers.formatDecimal(totalOutstanding,1,2)}">$0.00</h2>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4 equal-height-row">
            <div class="col-md-6">
                <div class="card shadow chart-card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="bi bi-pie-chart"></i> Liabilities by Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container"><canvas id="statusChart"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow chart-card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-bar-chart"></i> Amount by Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container"><canvas id="amountChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Summary Table -->
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-table"></i> Status Summary</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Status</th>
                                <th>Count</th>
                                <th>Total Amount</th>
                                <th>Average Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="entry : ${amountByStatus}">
                                <td>
                                    <span class="badge status-badge" th:classappend="${entry.key == 'OUTSTANDING' ? 'bg-outstanding' 
                                                   : (entry.key == 'PARTIAL' ? 'bg-partial' 
                                                   : (entry.key == 'PAID' ? 'bg-paid' 
                                                   : (entry.key == 'OVERDUE' ? 'bg-overdue' 
                                                   : 'bg-secondary')))}" th:text="${entry.key}"></span>
                                </td>
                                <td th:text="${statusCounts.get(entry.key)}">0</td>
                                <td th:text="'$' + ${#numbers.formatDecimal(entry.value,1,2)}">$0.00</td>
                                <td
                                    th:text="'$' + ${#numbers.formatDecimal(entry.value/statusCounts.get(entry.key),1,2)}">
                                    $0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Liabilities Table -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-list-check"></i> Liability Details</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Description</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Account</th>
                                <th>Amount</th>
                                <th>Outstanding</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="liability : ${liabilities}">
                                <td th:text="${liability.description}">-</td>
                                <td th:text="${#temporals.format(liability.dueDate,'yyyy-MM-dd')}">-</td>
                                <td>
                                    <span class="badge status-badge" th:classappend="${liability.status == 'OUTSTANDING' ? 'bg-outstanding' 
                                                   : (liability.status == 'PARTIAL' ? 'bg-partial' 
                                                   : (liability.status == 'PAID' ? 'bg-paid' 
                                                   : (liability.status == 'OVERDUE' ? 'bg-overdue' 
                                                   : 'bg-secondary')))}" th:text="${liability.status}"></span>
                                </td>
                                <td th:text="${liability.account?.accountName} ?: 'N/A'">-</td>
                                <td th:text="'$' + ${#numbers.formatDecimal(liability.amount,1,2)}">$0.00</td>
                                <td><span class="fw-bold"
                                        th:classappend="${liability.status == 'OUTSTANDING' || liability.status == 'PARTIAL'} ? 'text-warning' : 'text-success'"
                                        th:text="'$' + ${#numbers.formatDecimal(liability.outstandingAmount,1,2)}">$0.00</span>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(liabilities)}">
                                <td colspan="6" class="text-center text-muted py-4"><i
                                        class="bi bi-search display-4"></i>
                                    <p class="mt-2">No liabilities found</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            // Backend data
            const rawStatusLabels = [[${ statusLabels }]];
            const rawStatusData = [[${ statusData }]];
            const rawAmountLabels = [[${ amountLabels }]];
            const rawAmountData = [[${ amountData }]];

            // Define fixed order
            const fixedOrder = ["OUTSTANDING", "PARTIAL", "PAID", "OVERDUE"];

            // Map backend values into fixed order arrays
            const statusData = fixedOrder.map(label => {
                const idx = rawStatusLabels.indexOf(label);
                return idx !== -1 ? rawStatusData[idx] : 0;
            });

            const amountData = fixedOrder.map(label => {
                const idx = rawAmountLabels.indexOf(label);
                return idx !== -1 ? rawAmountData[idx] : 0;
            });

            const statusLabels = fixedOrder;
            const amountLabels = fixedOrder;

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 15, padding: 15 } }
                }
            };

            if (statusLabels && statusLabels.length > 0) {
                const ctx = document.getElementById('statusChart').getContext('2d');
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            data: statusData,
                            backgroundColor: ['#ffc107', '#17a2b8', '#28a745', '#dc3545']
                        }]
                    },
                    options: commonOptions
                });
            }

            if (amountLabels && amountLabels.length > 0) {
                const ctx = document.getElementById('amountChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: amountLabels,
                        datasets: [{
                            label: 'Amount',
                            data: amountData,
                            backgroundColor: ['#ffc107', '#17a2b8', '#28a745', '#dc3545']
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        });
    </script>

</body>

</html>